name: ğŸ” PR Quality Checks

on:
  pull_request:
    branches: [ main ]

jobs:
  test-before-merge:
    name: ğŸ§ª Testes PrÃ©-Merge
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ”§ Instalar dependÃªncias
      run: |
        pip install -r requirements.txt
        rfbrowser init
        
    - name: ğŸ§ª Executar todos os testes
      run: |
        robot --outputdir results \
              tests/api/auth_tests.robot \
              tests/api/movies_tests.robot \
              tests/api/reservations_tests.robot
        xvfb-run -a robot --outputdir results --variable HEADLESS:true tests/web/
        
    - name: ğŸ“Š Verificar resultados
      run: |
        if [ -f "results/output.xml" ]; then
          # Extrair estatÃ­sticas bÃ¡sicas
          TOTAL=$(grep -o 'stat.*pass="[0-9]*"' results/output.xml | head -1 | grep -o '[0-9]*')
          FAILED=$(grep -o 'stat.*fail="[0-9]*"' results/output.xml | head -1 | grep -o '[0-9]*' | tail -1)
          
          echo "ğŸ“Š Resultados: $TOTAL testes executados"
          
          if [ "$FAILED" = "0" ]; then
            echo "âœ… Todos os testes passaram - PR pode ser aprovado!"
          else
            echo "âŒ $FAILED teste(s) falharam - PR precisa de correÃ§Ãµes"
            exit 1
          fi
        else
          echo "âŒ Arquivo de resultados nÃ£o encontrado"
          exit 1
        fi
        
    - name: ğŸ’¬ Comentar no PR
      uses: actions/github-script@v6
      if: always()
      with:
        script: |
          const fs = require('fs');
          let message = '';
          
          if (fs.existsSync('results/output.xml')) {
            const xml = fs.readFileSync('results/output.xml', 'utf8');
            const passMatch = xml.match(/stat.*?pass="(\d+)"/);
            const failMatch = xml.match(/stat.*?fail="(\d+)"/);
            
            const passed = passMatch ? passMatch[1] : '0';
            const failed = failMatch ? failMatch[1] : '0';
            const total = parseInt(passed) + parseInt(failed);
            
            if (failed === '0') {
              message = `## âœ… Quality Gate PASSOU
              
              ğŸ‰ **Todos os ${total} testes passaram!**
              
              - âœ… API Tests: Funcionando
              - âœ… Web Tests: Funcionando
              - âœ… Quality Gate: APROVADO
              
              **ğŸš€ PR pronto para merge!**
              *Vercel farÃ¡ deploy automÃ¡tico apÃ³s o merge.*`;
            } else {
              message = `## âŒ Quality Gate FALHOU
              
              ğŸ“Š **Resultados dos testes:**
              - Total: ${total}
              - âœ… Passou: ${passed}
              - âŒ Falhou: ${failed}
              
              **ğŸ”§ AÃ§Ãµes necessÃ¡rias:**
              1. Verificar logs de falha
              2. Corrigir problemas identificados
              3. Executar testes localmente
              4. Fazer novo commit
              
              **âš ï¸ Deploy serÃ¡ bloqueado atÃ© correÃ§Ã£o.**`;
            }
          } else {
            message = `## âŒ Erro na execuÃ§Ã£o dos testes
            
            NÃ£o foi possÃ­vel executar os testes. Verifique:
            - DependÃªncias do projeto
            - ConfiguraÃ§Ã£o do ambiente
            - Logs de execuÃ§Ã£o`;
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: message
          });
        
    - name: ğŸ“Š Upload resultados
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: pr-test-results
        path: results/